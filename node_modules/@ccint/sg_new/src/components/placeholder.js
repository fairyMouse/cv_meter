import sg from '../sg.js'

sg.Component.define('Placeholder', {
  properties: {
    text: '请输入文本', // 提示文字
    color: '#999999' // 提示颜色
  },
  template: '<div class="sg_input_prompt" style="position: absolute;">{{@text}}</div>',
  onBeforeRender: function (next) {
    let self = this
    next({
      text: self.text
    }, 2)
  },
  onRender: function () {
    let self = this
    let $dom = self.$dom
    let $parent = self.$parent
    let index = (parseInt($dom.css('z-index')) || 0) + 1
    let parse = function (css) {
      return parseFloat($parent.css(css)) || 0
    }
    let position = $parent.position()

    $dom.css({
      color: self.color,
      fontSize: $parent.css('font-size'),
      lineHeight: $parent.css('line-height'),
      'max-width': parse('width') + 'px',
      top: position.top + parse('margin-top'),
      left: position.left + parse('margin-left'),
      right: position.right + parse('margin-right'),
      paddingTop: parse('padding-top') + parse('border-top-width'),
      paddingLeft: parse('padding-left') + parse('border-left-width'),
      zIndex: index
    }).addClass('hide_long')

    $parent.on('input keyup click blur', self.events.parentInput)

    $dom.on('mousedown', function (e) {
      $parent.focus()
    }).on('mouseup', function (e) {
      e.which === 3 && $dom.hide()
      $parent.focus() // bug ie 8 下点击水印无法使 input 聚焦
    })

    self.reflow()
  },
  events: {
    parentInput: function () {
      let self = this
      self.reflow()
    }
  },
  reflow: function () {
    let self = this
    self.$parent.val() ? self.$dom.hide() : self.$dom.show()
  },
  onBeforeDestroy: function (next) {
    let self = this
    self.$parent.off('input keyup click blur', self.events.parentInput)
    next()
  }
})

sg.Action.set({
  'sg-placeholder': {
    init: function ($dom) {
      sg.Component.Placeholder($dom, {text: $dom.attr('sg-placeholder')})
    }
  }
})
