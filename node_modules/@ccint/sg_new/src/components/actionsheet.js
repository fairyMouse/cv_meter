import $ from 'jquery'
import sg from '../sg.js'
import './actionsheet.css'

sg.Component.define('ActionSheet', {
  properties: {
    actionList: [], // 选项列表，每一个选项都是一个object，至少包含text属性用作展示
    title: '', // 标题
    cancelText: '取消', // 取消按钮文案
    onSelect: null, // 选中后的回调，选中的object作为参数
    onCancel: null // 取消后的回调
  },
  template: '<div class="sg_actionsheet">' +
  '<div class="sg_actionsheet_content_wrapper">' +
  '<div class="sg_actionsheet_content">' +
  '<div class="sg_actionsheet_group">' +
  '{{if title}}' +
  '<div class="sg_actionsheet_title">{{title}}</div>' +
  '{{/if}}' +
  '{{each actionList action index}}' +
  '<div class="sg_actionsheet_btn" data-id="{{index}}">{{action.text}}</div>' +
  '{{/each}}' +
  '</div>' +
  '<div class="sg_actionsheet_group sg_actionsheet_group_cancel">' +
  '<div class="sg_actionsheet_btn sg_actionsheet_btn_cancel">{{cancelText}}</div>' +
  '</div>' +
  '</div>' +
  '</div>' +
  '</div>',
  onBeforeRender: function (next) {
    let self = this
    next({
      actionList: self.actionList,
      title: self.title,
      cancelText: self.cancelText || '取消'
    }, 1)
  },
  onRender: function () {
    let self = this
    let $dom = self.$dom
    $dom.on(sg.config.transitionEnd, function () {
      let $cur_dom = $(this)
      if ($cur_dom.hasClass('active')) {
        return
      }
      self.destroy()
    })
    $dom.on('click', function (e) {
      let $target = $(e.target).closest('.sg_actionsheet_content_wrapper')
      if ($target.length) {
        return
      }
      self.hide()
    })
    $dom.find('.sg_actionsheet_btn').on('click', function () {
      let $cur_btn = $(this)
      let index = $cur_btn.data('id')
      if ($cur_btn.hasClass('sg_actionsheet_btn_cancel')) {
        self.onCancel && self.onCancel()
      } else {
        self.onSelect && self.onSelect(self.actionList[index])
      }
      self.hide()
    })
    sg.utils.reflow()
    $dom.addClass('active')
  },
  hide: function () {
    let self = this
    let $dom = self.$dom
    $dom && $dom.removeClass('active')
  }
})
