let $ = require('jquery')

$.fn.loadingStart = function (options) {
  options = options || {}
  this.each(function (i, item) {
    let self = $(item)
    let $loading = self.children('.sg_loading')
    let timer = $loading.data('sg_loading_timer') || 0
    let startTime = $loading.data('sg_loading_start_time') || 0
    let delay = options.delay || 500

    timer && clearTimeout(timer)
    if (startTime) {
      return
    }

    if (!$loading.length) {
      $loading = $('<div class="sg_loading"> <div class="sg_loading_spinner"> <div class="sg_loading_spinner_container"> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> </div> <div class="sg_loading_spinner_container"> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> </div> <div class="sg_loading_spinner_container"> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> <div class="sg_loading_spot"></div> </div> </div>数据加载中... </div>')
      self.append($loading)
    }

    if (options && $.isPlainObject(options)) {
      $loading.css(options)
    }

    $loading.data('sg_loading_timer', setTimeout(function () {
      $loading.show()
      $loading.data('sg_loading_start_time', +new Date())
    }, delay))
  })
}

$.fn.loadingStop = function () {
  this.each(function (i, item) {
    let self = $(item)
    let $loading = self.children('.sg_loading')
    let timer = $loading.data('sg_loading_timer') || 0
    let startTime = $loading.data('sg_loading_start_time') || 0
    let minTime = 500
    let delay

    timer && clearTimeout(timer)
    if (!startTime) {
      $loading.hide()
      return
    }
    let deltaTime = +new Date() - startTime
    if (deltaTime > minTime) {
      delay = 0
    } else {
      delay = minTime - deltaTime
    }

    $loading.data('sg_loading_start_time', 0)
    $loading.data('sg_loading_timer', setTimeout(function () {
      $loading.hide()
    }, delay))
  })
}
